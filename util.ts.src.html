<span class="hljs-keyword">import</span> { <span id="lsif524">dirname</span> } <span class="hljs-keyword">from</span> <span class="hljs-string"><span id="lsif538">&quot;path&quot;</span></span>;
<span class="hljs-keyword">import</span> { <span id="lsif560">mkdir</span>, <span id="lsif578">writeFile</span> } <span class="hljs-keyword">from</span> <span class="hljs-string"><span id="lsif592">&quot;fs/promises&quot;</span></span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span id="lsif600">myWriteFile</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr"><span id="lsif607">path</span></span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr"><span id="lsif614">content</span></span>: <span class="hljs-built_in">string</span>) <span id="lsif621">=&gt;</span> {
  <span class="hljs-keyword">const</span> <span id="lsif626">folder</span> = <span class="hljs-title function_"><span id="lsif630">dirname</span></span>(<span id="lsif632">path</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_"><span id="lsif634">mkdir</span></span>(<span id="lsif636">folder</span>, <span id="lsif648">{ <span class="hljs-attr"><span id="lsif641">recursive</span></span>: <span class="hljs-literal">true</span> }</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_"><span id="lsif650">writeFile</span></span>(<span id="lsif652">path</span>, <span id="lsif654">content</span>);
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_"><span id="lsif662">Addition</span></span> = <span id="lsif711">{
  <span class="hljs-attr"><span id="lsif672">position</span></span>: <span id="lsif693">{
    <span class="hljs-attr"><span id="lsif679">line</span></span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-attr"><span id="lsif686">character</span></span>: <span class="hljs-built_in">number</span>;
  }</span>;
  <span class="hljs-attr"><span id="lsif701">text</span></span>: <span class="hljs-built_in">string</span>;
}</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_"><span id="lsif719">putInSrc</span></span> = (<span class="hljs-params"><span id="lsif726">highlight</span>: <span class="hljs-built_in">string</span>, <span id="lsif733">additions</span>: <span id="lsif737">Addition</span>[]</span>) <span id="lsif742">=&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_"><span id="lsif747">key</span></span> = (<span class="hljs-params"><span id="lsif754">i</span>: <span class="hljs-built_in">number</span>, <span id="lsif761">j</span>: <span class="hljs-built_in">number</span></span>) <span id="lsif768">=&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${<span id="lsif770">i</span>}</span>,<span class="hljs-subst">${<span id="lsif772">j</span>}</span>`</span>;
  <span class="hljs-keyword">const</span> <span id="lsif777">additionMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_"><span id="lsif781">Map</span></span>();
  <span class="hljs-keyword">const</span> <span class="hljs-title function_"><span id="lsif786">addsInPlace</span></span> = (<span class="hljs-params"><span id="lsif793">i</span>: <span class="hljs-built_in">number</span>, <span id="lsif800">j</span>: <span class="hljs-built_in">number</span></span>) <span id="lsif807">=&gt;</span> {
    <span class="hljs-keyword">const</span> <span id="lsif812">a</span> = <span id="lsif816">additionMap</span>.<span class="hljs-title function_"><span id="lsif818">get</span></span>(<span class="hljs-title function_"><span id="lsif820">key</span></span>(<span id="lsif822">i</span>, <span id="lsif824">j</span>));
    <span class="hljs-keyword">if</span> (<span id="lsif826">a</span>) {
      <span class="hljs-keyword">return</span> <span id="lsif828">a</span>.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>;
  };
  <span id="lsif830">additions</span>.<span class="hljs-title function_"><span id="lsif842">forEach</span></span>(<span class="hljs-function">(<span class="hljs-params"><span id="lsif847">add</span></span>) <span id="lsif854">=&gt;</span></span> {
    <span class="hljs-keyword">const</span> <span id="lsif859">p</span> = <span id="lsif863">add</span>.<span class="hljs-property"><span id="lsif865">position</span></span>;
    <span class="hljs-keyword">const</span> <span id="lsif870">k</span> = <span class="hljs-title function_"><span id="lsif874">key</span></span>(<span id="lsif876">p</span>.<span class="hljs-property"><span id="lsif878">line</span></span>, <span id="lsif880">p</span>.<span class="hljs-property"><span id="lsif882">character</span></span>);
    <span class="hljs-keyword">let</span> <span id="lsif887">cur</span> = <span id="lsif891">additionMap</span>.<span class="hljs-title function_"><span id="lsif893">get</span></span>(<span id="lsif895">k</span>) ?? [];
    <span id="lsif897">additionMap</span>.<span class="hljs-title function_"><span id="lsif899">set</span></span>(<span id="lsif901">k</span>, <span id="lsif903">cur</span>);
    <span id="lsif905">cur</span>.<span class="hljs-title function_">push</span>(<span id="lsif907">add</span>.<span class="hljs-property"><span id="lsif909">text</span></span>);
  });
  <span class="hljs-keyword">let</span> <span id="lsif914">result</span> = <span class="hljs-string">&quot;&quot;</span>;
  <span class="hljs-keyword">let</span> <span id="lsif921">i</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> <span id="lsif928">j</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> <span id="lsif935">hline</span> = <span id="lsif939">highlight</span>;
  <span class="hljs-keyword">let</span> <span id="lsif944">p</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (<span id="lsif948">p</span> &lt; <span id="lsif950">hline</span>.<span class="hljs-property"><span id="lsif962">length</span></span>) {
    <span class="hljs-keyword">while</span> (<span id="lsif964">hline</span>[<span id="lsif966">p</span>] == <span class="hljs-string">&#x27;&lt;&#x27;</span>) {
      <span class="hljs-keyword">while</span> (<span id="lsif968">hline</span>[<span id="lsif970">p</span>] != <span class="hljs-string">&#x27;&gt;&#x27;</span>) {
        <span id="lsif972">result</span> += <span id="lsif974">hline</span>[<span id="lsif976">p</span>];
        <span id="lsif978">p</span> += <span class="hljs-number">1</span>;
      }
      <span id="lsif980">result</span> += <span id="lsif982">hline</span>[<span id="lsif984">p</span>];
      <span id="lsif986">p</span> += <span class="hljs-number">1</span>;
    }
    <span id="lsif988">result</span> += <span class="hljs-title function_"><span id="lsif990">addsInPlace</span></span>(<span id="lsif992">i</span>, <span id="lsif994">j</span>);
    <span id="lsif996">j</span> += <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (<span id="lsif998">p</span> &gt;= <span id="lsif1000">hline</span>.<span class="hljs-property"><span id="lsif1002">length</span></span>) <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">if</span> (<span id="lsif1004">hline</span>[<span id="lsif1006">p</span>] == <span class="hljs-string">&#x27;\n&#x27;</span>) {
      <span id="lsif1008">result</span> += <span id="lsif1010">hline</span>[<span id="lsif1012">p</span>];
      <span id="lsif1014">p</span> += <span class="hljs-number">1</span>;
      <span id="lsif1016">j</span> = <span class="hljs-number">0</span>;
      <span id="lsif1018">i</span> += <span class="hljs-number">1</span>;
      <span class="hljs-keyword">continue</span>;  
    }
    <span class="hljs-keyword">if</span> (<span id="lsif1020">hline</span>[<span id="lsif1022">p</span>] == <span class="hljs-string">&#x27;&amp;&#x27;</span>) {
      <span class="hljs-keyword">while</span> (<span id="lsif1024">hline</span>[<span id="lsif1026">p</span>] != <span class="hljs-string">&#x27;;&#x27;</span>) {
        <span id="lsif1028">result</span> += <span id="lsif1030">hline</span>[<span id="lsif1032">p</span>];
        <span id="lsif1034">p</span> += <span class="hljs-number">1</span>;
      }
    }
    <span id="lsif1036">result</span> += <span id="lsif1038">hline</span>[<span id="lsif1040">p</span>];
    <span id="lsif1042">p</span> += <span class="hljs-number">1</span>;
  }
  <span id="lsif1044">result</span> += <span class="hljs-title function_"><span id="lsif1046">addsInPlace</span></span>(<span id="lsif1048">i</span>, <span id="lsif1050">j</span>);
  <span class="hljs-keyword">return</span> <span id="lsif1052">result</span>;
};
